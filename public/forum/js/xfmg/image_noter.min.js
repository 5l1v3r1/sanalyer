/*
 * XenForo image_noter.min.js
 * Copyright 2010-2017 XenForo Ltd.
 * Released under the XenForo License Agreement: https://xenforo.com/license-agreement
 */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,f,e){b instanceof String&&(b=String(b));for(var g=b.length,a=0;a<g;a++){var c=b[a];if(f.call(e,c,a,b))return{i:a,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,f,e){b!=Array.prototype&&b!=Object.prototype&&(b[f]=e.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,f,e,g){if(f){e=$jscomp.global;b=b.split(".");for(g=0;g<b.length-1;g++){var a=b[g];a in e||(e[a]={});e=e[a]}b=b[b.length-1];g=e[b];f=f(g);f!=g&&null!=f&&$jscomp.defineProperty(e,b,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,e){return $jscomp.findInternal(this,b,e).v}},"es6","es3");var XFMG=window.XFMG||{};
!function(b,f,e,g){XFMG.ImageNoter=XF.Element.newHandler({options:{image:".js-mediaImage",toggleId:"#js-noterToggle",editUrl:null},$image:null,$toggle:null,$cropBox:null,$editingNote:null,active:!1,trigger:null,tooltip:null,init:function(){var a=this.$target.find(this.options.image),c=b(this.options.toggleId);a.length&&a.is("img")||console.error("Image noter must contain an img element");this.$image=a;if(a.prop("complete"))this.prepareNotes();else a.on("load",b.proxy(this,"prepareNotes"));b(f).onPassive("resize",
b.proxy(this,"prepareNotes"));c.length&&(this.$toggle=c,c.on("click",b.proxy(this,"toggleNewNoteEditor")))},prepareNotes:function(){var a=this,c=this.$image,d=c[0].naturalWidth/c[0].width;this.$target.find(".js-mediaNote").each(function(){var c=b(this),e=c.data("note-data"),f;for(f in e)e.hasOwnProperty(f)&&(e[f+"_"]=e[f]/d);c.css({left:e.tag_x1_,top:e.tag_y1_,width:e.tag_width_,height:e.tag_height_});c.data("prepared")||a.initNote(c)})},initNote:function(a){var c=this.getTooltipElement(a),d=new XF.TooltipElement(c.clone().contents(),
{extraClass:"tooltip--mediaNote tooltip--mediaNote--plain",noTouch:!1,html:!0}),e=this.$target.find(".media-container-image").first(),f=this;d.addSetupCallback(function(c){c.on("mouseenter",function(){e.addClass("is-tooltip-active")});c.on("mouseleave",function(){e.removeClass("is-tooltip-active")});c.find(".js-mediaNoteTooltipEdit").on("click",b.proxy(f,"editNote",a))});var g=new XF.TooltipTrigger(a,d,{maintain:!0,trigger:"hover focus click"});g.init();a.data("prepared",!0);a.data("tooltip",d);a.data("trigger",
g);a.show();c.remove()},getTooltipElement:function(a){return XF.findRelativeIf("< .js-mediaContainerImage | .js-mediaNoteTooltip"+a.data("note-id"),a)},editNote:function(a){var c=a.data("note-data"),d=this;a.trigger("tooltip:hide");this.$image.cropper({viewMode:2,dragMode:"none",aspectRatio:1,modal:!1,highlight:!1,movable:!1,rotatable:!1,scalable:!1,zoomable:!1,toggleDragModeOnDblclick:!1,data:{x:c.tag_x1,y:c.tag_y1,width:c.tag_width,height:c.tag_height},ready:function(){d.$editingNote=a;d.$cropBox=
d.$target.find(".cropper-crop-box").first();d.tooltip||d.trigger||(d.tooltip=new XF.TooltipElement(b.proxy(d,"getEditNoteTooltipContent"),{extraClass:"tooltip--mediaNote",html:!0,loadRequired:!0}),d.trigger=new XF.TooltipTrigger(d.$cropBox,d.tooltip,{maintain:!0,trigger:""}),d.trigger.init(),d.$cropBox.trigger("tooltip:show"),d.$image.trigger("cropend"))},cropstart:b.proxy(this,"editNoteCropstart"),cropend:b.proxy(this,"editNoteCropend")})},editNoteCropstart:function(a){this.trigger&&this.$cropBox.trigger("tooltip:hide")},
editNoteCropend:function(a){var c=this;this.$cropBox.trigger("tooltip:show");this.tooltip.$tooltip.on("tooltip:shown",function(a){a=b(a.target);var d=c.getCoordsFromCropper();a.find(".js-noteData").val(JSON.stringify(d))})},getEditNoteTooltipContent:function(a){var c=this;XF.ajax("get",this.options.editUrl,{note_id:this.$editingNote.data("note-id")},function(b){c.editNoteLoaded(b,a)},{skipDefault:!0,skipError:!0,global:!1})},editNoteLoaded:function(a,c){if(a.html){var d=this;XF.setupHtmlInsert(a.html,
function(a,e,f){c(a);a.find(".js-cancelButton").on("click",b.proxy(d,"editNoteCancel"));a.on("ajax-submit:response",b.proxy(d,"editNoteHandle"))})}},editNoteCancel:function(a){this.$cropBox&&(this.$cropBox.trigger("tooltip:hide"),this.$cropBox=null);this.tooltip&&(this.tooltip.destroy(),this.trigger=this.tooltip=null);this.$image.cropper("destroy");this.$editingNote=null;"string"===typeof a&&XF.flashMessage(a,3E3)},editNoteHandle:function(a,c){if(!c.errors&&!c.exception)if(a.preventDefault(),this.$editingNote.data("tooltip").destroy(),
this.$editingNote.remove(),c.deleted)this.editNoteCancel(c.message);else{var b=this;XF.setupHtmlInsert(c.html,function(a,d,e){b.$target.find(".js-mediaContainerImage").prepend(a);b.editNoteCancel(c.message);XF.activate(a)});setTimeout(function(){b.prepareNotes()},500)}},toggleNewNoteEditor:function(){this.active?this.disableNewNoteEditor():this.enableNewNoteEditor()},disableNewNoteEditor:function(a){if(this.active){this.$cropBox&&this.$cropBox.trigger("tooltip:hide");this.tooltip&&(this.tooltip.destroy(),
this.trigger=this.tooltip=null);this.$image.cropper("destroy");var c=this.$toggle;c.find(".button-text").html(XF.htmlspecialchars(c.data("inactive-label")));c.removeClass("button--icon--"+c.data("active-icon"));c.addClass("button--icon--"+c.data("inactive-icon"));a?XF.flashMessage(a,3E3):XF.flashMessage(c.data("inactive-message"),3E3);this.active=!1}},enableNewNoteEditor:function(){this.active||this.$image.cropper({viewMode:2,dragMode:"crop",aspectRatio:1,modal:!1,highlight:!1,autoCrop:!1,movable:!1,
rotatable:!1,scalable:!1,zoomable:!1,toggleDragModeOnDblclick:!1,ready:b.proxy(this,"newNoteReady"),cropstart:b.proxy(this,"newNoteCropstart"),cropend:b.proxy(this,"newNoteCropend")})},newNoteReady:function(){var a=this.$toggle;a.find(".button-text").html(XF.htmlspecialchars(a.data("active-label")));a.removeClass("button--icon--"+a.data("inactive-icon"));a.addClass("button--icon--"+a.data("active-icon"));this.$cropBox=this.$target.find(".cropper-crop-box").first();XF.flashMessage(a.data("active-message"),
3E3);this.active=!0},newNoteCropstart:function(a){this.trigger&&this.$cropBox.trigger("tooltip:hide")},newNoteCropend:function(a){this.tooltip||this.trigger||(this.tooltip=new XF.TooltipElement(b.proxy(this,"getNewNoteTooltipContent"),{extraClass:"tooltip--mediaNote",html:!0,loadRequired:!0}),this.trigger=new XF.TooltipTrigger(this.$cropBox,this.tooltip,{maintain:!0,trigger:""}),this.trigger.init());var c=this;this.$cropBox.trigger("tooltip:show");this.tooltip.$tooltip.on("tooltip:shown",function(a){a=
b(a.target);var d=c.getCoordsFromCropper();a.find(".js-noteData").val(JSON.stringify(d))})},getNewNoteTooltipContent:function(a){var c=this;XF.ajax("get",this.options.editUrl,{},function(b){c.newNoteLoaded(b,a)},{skipDefault:!0,skipError:!0,global:!1})},newNoteLoaded:function(a,c){if(a.html){var d=this;XF.setupHtmlInsert(a.html,function(a,e,f){c(a);a.find(".js-cancelButton").on("click",b.proxy(d,"newNoteCancel"));a.on("ajax-submit:response",b.proxy(d,"newNoteHandle"))})}},newNoteCancel:function(){this.$cropBox.trigger("tooltip:hide");
this.$image.cropper("clear")},newNoteHandle:function(a,b){if(!b.errors&&!b.exception){a.preventDefault();var c=this;XF.setupHtmlInsert(b.html,function(a,d,e){c.$target.find(".js-mediaContainerImage").prepend(a);c.disableNewNoteEditor(b.message);XF.activate(a)});setTimeout(function(){c.prepareNotes()},500)}},getCoordsFromCropper:function(){var a=this.$image.cropper("getData");return{tag_x1:a.x,tag_y1:a.y,tag_width:a.width,tag_height:a.height}}});XF.Element.register("image-noter","XFMG.ImageNoter")}(jQuery,
window,document);
